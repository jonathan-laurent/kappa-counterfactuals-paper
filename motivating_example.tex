\pagebreak

\section{Motivating example}\label{sec:example}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% BACKGROUND ON KAPPA
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MISSING
% Rules cannot create or delete agents
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this section, we give some background information on the Kappa
modelling language and introduce a toy example that motivates the need
for counterfactual reasoning in analyzing the causal structure of
simulationt traces.


\subsection{Some background on Kappa}

In Kappa, proteins and other organic molecules are modelled by
abstract \emph{agents} with distinguishable \emph{sites}. Agents can
bind to each other through these sites and some sites also hold an
internal state. A site can only be engaged in at most one bond at a
time. The number and the nature of the sites featured by an agent
depend on its \emph{type}.
% , each type of agent being described in the model's
% \emph{signature}.
In our running example, there are two types
of agents: substrates $S$ and kinases $K$. Agents of both type feature
a binding site and a phosphorylation site with two possible
internal states: \emph{unphosphorylated} and \emph{phosphorylated}.

We call \emph{mixture} a multiset of agents for which the internal
state and binding state of every site is fully specified.  Individual
agents are given global identifiers so that we can refer to them
unambiguously. \input{figures/mixture}
\noindent
Chemical interactions between agents are modelled by local
mixture-rewriting \emph{rules}.  A rule $r$ consists in a left-hand
side $(\RLHS{r})$, a right-hand-side $(\RRHS{r})$ and a firing rate
$(\lambda_r)$.  Together, the rules of a model denote a continuous-time
Markov chain where
\begin{inparaenum}[i)]
\item states are mixtures and
\item for every rule $r$,
any instance of $L_r$ is rewritten into $\RRHS{r}$ at rate
$\lambda_r$.
\end{inparaenum}
Agents in our example model are subject to the set of
rules depicted in Figure~\ref{fig:model}. As expressed by these rules,
kinases and substrates can bind to each other provided that their
respective binding sites are free (rule ``$b$''). However, the
resulting complex is very unstable unless the kinase involved is
phosphorylated, which we model by introducing two unbind rules
(``$u$'' and ``$u^{*}$'') with different rates. Also, a substrate can
get phosphorylated when it is bound to a kinase (rule
``$p$''). Finally, for the sake of simplicity, we model the
phosphorylation process of kinases as a spontaneous process (rule
``$pk$''). 

\input{figures/model}

Importantly, not every site of an agent has to be mentioned in a rule.
Following the \textit{``don't care, don't write"} principle, sites not
mentioned in a rule are left unchanged by it. Although it may appear
trivial, this is a defining feature of rule-based models, contrasting
with other modelling frameworks %that are frequently used in biology
like Petri-nets and differential equations where the chemical species
involved in a reaction have to be fully specified. The most obvious
benefit of the rule-based approach is that it enables a concise and
scalable representation of complex chemical systems that can generate
a combinatorial number of distinct species. More significantly for our
purposes though, it is especially suitable for causal analysis as it
does not obfuscate the causal structure of a system with irrelevant
context information, ideally enabling a one-to-one correspondence
between rules and elementary physical mechanisms.

A \emph{rule instance}, also called \emph{abstract event}, is a pair
$(r, \xi)$ where $r$ is a rule and $\xi$ is a map from the agents
featured in $\RLHS{r}$ to global agent identifiers.  We say
that $(r, \xi)$ is \emph{triggerable} in mixture $m$, which we write
$\TRIGGERABLE{m}{(r, \xi)}$, if $\xi$ describes an embedding of $L_r$ into $m$. 
We write
\[\EMBS{r}{m} \eqdef \{ \xi \,:\, \TRIGGERABLE{m}{(r, \xi)}\}\] the set
of all such embeddings. If $m \vdash (r, \xi)$, we write $\UPDATE{m}{(r, \xi)}$
the new mixture we get from $m$ after applying rule instance $(r, \xi)$
by rewriting the codomain of $\xi$ into $\RRHS{r}$.
Finally, in a given mixture $m$, the \emph{activity} of a rule
$r$ is defined as the product $\lambda_r|\EMBS{r}{M}|$ of its reaction rate 
by the number of embeddings of $L_r$ into $m$. For example, 
in Figure~\ref{fig:mixture}, rule $b$ has activity $2\lambda_b$ and rule
$u$ has activity $0$. The \emph{total activity} of a mixture is defined
as the sum of the activities of every rule.

Given an initial mixture, the continuous Markov chain underlying
a model can be simulated using the so-called \emph{Gillespie algorithm}
that is depicted Algorithm~\ref{alg:gillespie} and which consists
in repeating the following steps:
\begin{inparaenum}[1)]
\item draw the time before the next simulation event from an
  exponential distribution of parameter the total activity of
  the rules and increment the current time by this amount
\item draw a rule $r$ with probability proportional to its activity
\item pick an instance of the left hand side of $r$ uniformly in the
  current mixture and rewrite it.
\end{inparaenum}
The Gillespie algorithm outputs a sequence of \emph{events}, an event
being formally defined as a pair $(e, t)$ where $e$ is an abstract event
and $t$ its time of happening.


\input{algos/gillespie}


% Remaining: embeddings, triggerable, events, Gillespie
% Unclear: update notation ? No need.










%Stochastic simulations of Kappa models can be run using the Gillespie
%algorithm, which is summarized Listing~\ref{alg:gillespie}.

%\input{algos/gillespie}

% In Gillespie's algorithm, the activity of a rule $r$ is defined as the
% product $\lambda_r|\EMBS{r}{M}|$ of its reaction rate by the number of
% embeddings of its left hand side in the current reaction mixture.
% Then, 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% TRADITIONAL PATHWAY ANALYSIS FALLS SHORT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Where traditional pathway analysis falls short}



For the sake of simplicity, consider an initial mixture $I$ with only
a single kinase and a single substrate whose sites are free and
unphosphorylated. We then ask: Starting from $I$, \textbf{how} is $p$
triggered ? We are not merely looking for an account of reachability
but rather for causal narratives, that is, collections of necessary
events connected by causal influences. 

A stochastic simulation \cite{DanosEtAl-APLAS07} might produce the
following trace (events are labelled by the rules that induced them):
\begin{align}\label{example-trace} b,\ \ u,\ \ pk,\ \ b,\ \ p,\ \
  u^{*},\ \ \cdots
\end{align} Figure~\ref{fig:dumb-story} depicts the causal narrative
explaining the occurrence of $p$ according to existing techniques
\cite{DBLP:conf/fsttcs/DanosFFHH12,DanosEtAl-CONCUR07}. The arrow
between $b$ and $p$ is called an \textit{activation arrow}, meaning
that $b$ modifies an aspect of state (by creating a link) that enables
$p$ to happen.

\input{figures/dumb-story}

This narrative, however, is blind to the critical role of $pk$ in the
original trace. Looking at the rules in Figure~\ref{fig:model} one
notes that:
\begin{inparaenum}[(i)]
\item the phosphorylation rule $p$ is slow
\item the average time $K$ and $S$ remain bound depends on whether $K$
  is phosphorylated, as manifest in the two unbinding rules $u$ (fast,
  if $K$ is not phosphorylated) and $u^{*}$ (slow, if $K$ is
  phosphorylated).
\end{inparaenum} It seems reasonable to assert that $p$ would probably
not have happened had $pk$ not happened, as the opportunity for $p$
would have been cut short by a fast unbinding event. We therefore
argue that $pk$, although it does not activate $b$ or $p$ directly,
should be part of a causal narrative for $p$. Reasoning of this kind
is \textit{counterfactual} and can be deployed to define causality
\cite{lewis1974causation,lewis2000causation}.

In section~\ref{sec:counterfactual}, we give a rigorous semantics to
this line of reasoning. In section~\ref{sec:inhibition} we show that
counterfactual statements can be expressed using inhibition arrows,
leading to the explanation shown in Figure~\ref{fig:cex}.

% Therefore, although the causal relevance of $pk$ cannot be justified
by activation arrows, it is supported by a counterfactual statement.
% In the rest of this abstract, we %give a formal semantics to
counterfactual statements and investigate how %they can be used %to
produce more satisfying causal explanations.